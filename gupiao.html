<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aè‚¡è¡¥ä»“æˆæœ¬è®¡ç®—å™¨ç›ˆäºåˆ†æ</title>
    <style>
        /* --- ç°ä»£åŒ– UI / åŸºç¡€æ ·å¼ (æ¨¡ä»¿ Tailwind CSS é£æ ¼) --- */
        :root {
            --primary: #3b82f6; /* Blue 500 */
            --primary-dark: #2563eb; /* Blue 600 */
            --bg: #f9fafb; /* Gray 50 */
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            /* é¢œè‰²åè½¬ï¼šç›ˆåˆ©/ä¸Šæ¶¨ï¼ˆçº¢ï¼‰ï¼ŒäºæŸ/ä¸‹è·Œï¼ˆç»¿ï¼‰ */
            --profit: #ef4444;   /* Red 500 (ç›ˆåˆ©/ä¸Šæ¶¨) */
            --loss: #10b981;     /* Green 500 (äºæŸ/ä¸‹è·Œ) */
            --warning: #f59e0b;  /* Amber 500 (æç¤º) */
            --border: #e5e7eb;   /* Gray 200 */
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-bottom: 50px;
        }

        /* å¤´éƒ¨ */
        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .header p { margin: 5px 0 0; font-size: 0.875rem; opacity: 0.9; }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 4px;
        }
        .tab {
            flex: 1;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-sub);
            transition: all 0.2s;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .tab:hover { background-color: #f3f4f6; }
        /* åˆå§‹ä¸è®¾ç½® activeï¼Œåœ¨ JS ä¸­è®¾ç½®é»˜è®¤æ¿€æ´»é¡¹ */
        .tab.active {
            color: var(--primary-dark);
            background: var(--card-bg);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .content { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: var(--text-main);
            font-weight: 600;
        }
        
        /* è¾“å…¥æ¡† */
        .input-wrapper input, .input-wrapper textarea {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #ffffff;
        }
        .input-wrapper input:focus, .input-wrapper textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* ring-4 */
        }
        .input-wrapper { position: relative; }
        .input-suffix {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-sub);
            font-size: 0.875rem;
        }

        /* è´¹ç‡è®¾ç½® */
        .settings-toggle {
            font-size: 0.875rem;
            color: var(--primary);
            cursor: pointer;
            margin-bottom: 15px;
            display: inline-block;
            font-weight: 500;
        }
        .advanced-settings {
            display: none;
            background: #fefce8; /* Yellow 50 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fde68a; /* Yellow 200 */
        }
        .advanced-settings.show { display: block; }

        /* æŒ‰é’® */
        .btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-top: 10px;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn:active { transform: scale(0.99); }

        /* ç»“æœå¡ç‰‡ */
        .result-card {
            margin-top: 25px;
            background: #eff6ff; /* Blue 50 */
            border: 1px solid #bfdbfe; /* Blue 200 */
            border-radius: 12px;
            padding: 20px;
            display: none;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        .result-row.info {
            color: var(--text-sub);
            font-size: 0.8rem;
            border-bottom: 1px dotted var(--border);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .result-row.total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #bfdbfe;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary-dark);
        }
        /* é¢œè‰²ç±»åè½¬ (Aè‚¡é£æ ¼) */
        .highlight-red { color: var(--profit); font-weight: 700; }
        .highlight-green { color: var(--loss); font-weight: 700; }
        .fee-note { font-size: 0.75rem; color: var(--text-sub); margin-top: 10px; text-align: right; }

        /* --- å†å²è®°å½• UI ä¼˜åŒ– (æŒä»“åˆ—è¡¨) --- */
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); /* shadow-sm */
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .history-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
        }
        .stock-name-display { font-size: 1rem; font-weight: 700; color: var(--text-main); }
        .timestamp-display { font-size: 0.75rem; color: var(--text-sub); }
        
        .history-item-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.9rem;
        }
        .history-item-content strong { color: var(--text-main); font-weight: 600; }
        .memo-snippet {
            font-size: 0.8rem;
            color: var(--text-sub);
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        /* ç›ˆäºè¡Œè°ƒæ•´ä¸ºä¸¤åˆ—æ˜¾ç¤ºï¼šé‡‘é¢å’Œæ¯”ä¾‹ */
        .history-pnl {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border);
            font-weight: 700;
            display: grid;
            grid-template-columns: 1fr 1fr; /* åˆ†æˆä¸¤åˆ— */
            gap: 10px;
        }
        .pnl-label { color: var(--text-sub); font-weight: 500; font-size: 0.85rem; }
        .pnl-value { text-align: right; }


        .history-item-actions {
            margin-top: 15px;
            text-align: right;
        }
        .history-item-actions button {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        .history-item-actions .btn-delete { color: var(--primary); border-color: var(--primary); }
        .history-item-actions .btn-edit { color: var(--primary); border-color: var(--primary); }
        .history-item-actions button:hover { opacity: 0.9; }

        /* --- Toast Notification System ä¼˜åŒ– --- */
        #toastContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            min-width: 250px;
            text-align: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        /* ä¿æŒ Toast é¢œè‰²ä¸€è‡´ï¼Œä½¿ç”¨æˆåŠŸ/è­¦å‘Šè‰² */
        .toast.success { background-color: var(--loss); } 
        .toast.error { background-color: var(--profit); } 
        .toast.warning { background-color: var(--warning); color: var(--text-main); }
    </style>
</head>
<body>

<div id="toastContainer"></div>

<div class="container">
    <div class="header">
        <h1>ğŸ“ˆ Aè‚¡è¡¥ä»“è®¡ç®—å™¨</h1>
        <p>ä¸“ä¸šè®°å½•ä¸ç›ˆäºåˆ†æ</p>
    </div>

    <div class="tabs">
        <div class="tab" data-mode="cost" onclick="switchTab('cost')">ç®—æ–°æˆæœ¬</div>
        <div class="tab" data-mode="target" onclick="switchTab('target')">åæ¨éœ€è¡¥å¤šå°‘</div>
        <div class="tab active" data-mode="history" onclick="switchTab('history')">æŒä»“åˆ—è¡¨ ğŸ’¾</div>
    </div>

    <div class="content">
        <div id="mode-history">
            <ul class="history-list" id="historyList">
                </ul>
        </div>
        
        <div id="calculator-area" style="display:none;">
             <input type="hidden" id="editingId" value="">

            <div class="form-group">
                <label>è‚¡ç¥¨/åŸºé‡‘åç§°</label>
                <div class="input-wrapper">
                    <input type="text" id="stockName" placeholder="ä¾‹å¦‚ï¼šè´µå·èŒ…å° / 510300">
                </div>
            </div>
            
            <div class="form-group">
                <label>å½“å‰æŒä»“è‚¡æ•°</label>
                <div class="input-wrapper">
                    <input type="number" id="currentShares" placeholder="ä¾‹å¦‚ï¼š1000">
                    <span class="input-suffix">è‚¡</span>
                </div>
            </div>
            <div class="form-group">
                <label>å½“å‰æˆæœ¬ä»· (ä¿æœ¬ä»·)</label>
                <div class="input-wrapper">
                    <input type="number" id="currentCost" step="0.001" placeholder="ä¾‹å¦‚ï¼š10.5">
                    <span class="input-suffix">å…ƒ</span>
                </div>
            </div>
            <div class="form-group">
                <label>å½“å‰å¸‚åœºä»· (è¡¥ä»“ä»·)</label>
                <div class="input-wrapper">
                    <input type="number" id="marketPrice" step="0.001" placeholder="ä¾‹å¦‚ï¼š9.0">
                    <span class="input-suffix">å…ƒ</span>
                </div>
            </div>

            <div class="settings-toggle" onclick="toggleSettings()">âš™ï¸ è´¹ç‡è®¾ç½® (é»˜è®¤ä¸‡3ï¼Œç‚¹å‡»ä¿®æ”¹)</div>
            <div class="advanced-settings" id="settingsPanel">
                <div class="form-group">
                    <label>ä½£é‡‘è´¹ç‡ (å¦‚ä¸‡3å¡«0.0003)</label>
                    <input type="number" id="commissionRate" value="0.0003" step="0.0001">
                </div>
                <div class="form-group">
                    <label>æœ€ä½ä½£é‡‘ (å…ƒ)</label>
                    <input type="number" id="minCommission" value="5">
                </div>
                <div class="form-group">
                    <label>è¿‡æˆ·è´¹ç‡ (æ²ªå¸‚ä¸‡0.1ï¼Œæ·±å¸‚/ETFé€šå¸¸ä¸º0)</label>
                    <input type="number" id="transferRate" value="0.00001" step="0.00001">
                </div>
            </div>
            
            <div class="form-group">
                <label>ğŸ““ å¤‡å¿˜/åˆ†æ (è®°å½•æ“ä½œç†ç”±)</label>
                <div class="input-wrapper">
                    <textarea id="memo" placeholder="ä¾‹å¦‚ï¼šå¸‚åœºæƒ…ç»ªä½è¿·ï¼Œè·Œç ´æ”¯æ’‘ä½ï¼Œè®¡åˆ’è¡¥ä»“æ‘Šä½æˆæœ¬ï¼Œé¢„è®¡æŒæœ‰ä¸€å¹´ã€‚"></textarea>
                </div>
            </div>

            <div id="mode-cost">
                <div class="form-group">
                    <label style="color:var(--primary-dark)">ğŸ‘‡ è®¡åˆ’è¡¥ä»“è‚¡æ•° (å¡« 0 å¯åªè®¡ç®—ç›ˆäº)</label>
                    <div class="input-wrapper">
                        <input type="number" id="buyShares" placeholder="å¿…é¡»ä¸º100çš„å€æ•°æˆ– 0" step="100">
                        <span class="input-suffix">è‚¡</span>
                    </div>
                </div>
                <button class="btn" onclick="calculateNewCost()">è®¡ç®—å¹¶ä¿å­˜æŒä»“</button>
            </div>

            <div id="mode-target" style="display:none;">
                <div class="form-group">
                    <label style="color:var(--primary-dark)">ğŸ¯ ç›®æ ‡æˆæœ¬ä»·</label>
                    <div class="input-wrapper">
                        <input type="number" id="targetCost" placeholder="æƒ³é™åˆ°å¤šå°‘ï¼Ÿ" step="0.01">
                        <span class="input-suffix">å…ƒ</span>
                    </div>
                </div>
                <button class="btn" onclick="calculateTarget()">åæ¨å¹¶ä¿å­˜æŒä»“</button>
            </div>

            <div class="result-card" id="resultCard">
                </div>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'stock_calc_history';
    let currentMode = 'history'; // é»˜è®¤æ¨¡å¼æ”¹ä¸º history

    // --- Toast Notification System ---
    let toastTimeout;
    function showToast(message, type = 'info') {
        clearTimeout(toastTimeout);
        
        const container = document.getElementById('toastContainer');
        container.innerHTML = ''; 
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                container.innerHTML = '';
            }, 300);
        }, 3000);
    }
    
    // --- Form Clearing ---
    function clearForm() {
        document.getElementById('stockName').value = '';
        document.getElementById('currentShares').value = '';
        document.getElementById('currentCost').value = '';
        document.getElementById('marketPrice').value = '';
        document.getElementById('buyShares').value = '';
        document.getElementById('targetCost').value = '';
        document.getElementById('memo').value = '';
        document.getElementById('resultCard').style.display = 'none';
        document.getElementById('editingId').value = '';
    }
    
    // --- Tab Switching and UI Helpers ---

    function switchTab(mode) {
        currentMode = mode;
        const tabs = document.querySelectorAll('.tab');
        const calcArea = document.getElementById('calculator-area');
        const modeCost = document.getElementById('mode-cost');
        const modeTarget = document.getElementById('mode-target');
        const modeHistory = document.getElementById('mode-history');
        const resultCard = document.getElementById('resultCard');
        
        tabs.forEach(tab => tab.classList.remove('active'));

        if (mode === 'history') {
            document.querySelector(`[data-mode="history"]`).classList.add('active');
            calcArea.style.display = 'none';
            modeHistory.style.display = 'block';
            resultCard.style.display = 'none';
            renderHistory();
        } else {
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            calcArea.style.display = 'block';
            modeHistory.style.display = 'none';
            modeCost.style.display = mode === 'cost' ? 'block' : 'none';
            modeTarget.style.display = mode === 'target' ? 'block' : 'none';
        }
    }

    function toggleSettings() {
        document.getElementById('settingsPanel').classList.toggle('show');
    }

    function showResult(html) {
        const card = document.getElementById('resultCard');
        card.innerHTML = html;
        card.style.display = 'block';
        card.scrollIntoView({ behavior: 'smooth' });
    }

    // --- Calculation Logic ---

    function getFees(amount) {
        const rate = parseFloat(document.getElementById('commissionRate').value);
        const minFee = parseFloat(document.getElementById('minCommission').value);
        const transferRate = parseFloat(document.getElementById('transferRate').value);

        let comm = amount * rate;
        if (comm < minFee) comm = minFee;
        
        let transfer = amount * transferRate;
        return comm + transfer;
    }

    function calculateNewCost() {
        const stockName = document.getElementById('stockName').value.trim() || 'æœªå‘½åè‚¡ç¥¨/åŸºé‡‘';
        const memo = document.getElementById('memo').value.trim();
        const currentShares = parseFloat(document.getElementById('currentShares').value);
        const currentCost = parseFloat(document.getElementById('currentCost').value);
        const marketPrice = parseFloat(document.getElementById('marketPrice').value);
        let buyShares = parseFloat(document.getElementById('buyShares').value);
        
        // å½“ buyShares ä¸ºç©ºæˆ– NaN æ—¶ï¼Œé»˜è®¤ä¸º 0
        if (isNaN(buyShares)) {
            buyShares = 0;
            document.getElementById('buyShares').value = 0; // è‡ªåŠ¨å¡«å……ä¸º 0
        }


        if (isNaN(currentShares) || isNaN(currentCost) || isNaN(marketPrice)) {
            showToast("è¯·å¡«å†™å½“å‰æŒä»“ã€æˆæœ¬ä»·å’Œå¸‚åœºä»·", 'error');
            return;
        }

        const oldAmount = currentShares * currentCost;
        const buyAmount = buyShares * marketPrice;
        
        let fees = 0;
        
        // --- ä¿®æ­£: ä»…åœ¨å®é™…å‘ç”Ÿè´­ä¹°æ—¶è®¡ç®—è´¹ç”¨ ---
        if (buyShares > 0) {
            fees = getFees(buyAmount);
        }
        
        const totalCost = oldAmount + buyAmount + fees;
        const totalShares = currentShares + buyShares;
        
        // è®¡ç®—æ–°çš„å¹³å‡æˆæœ¬ (å¦‚æœæ€»è‚¡æ•°ä¸º 0, åˆ™æˆæœ¬ä¸ºæ—§æˆæœ¬)
        const newAvg = totalShares > 0 ? totalCost / totalShares : currentCost; 
        
        // å½“ buyShares = 0 æ—¶ï¼Œæˆæœ¬ä¸‹é™å¹…åº¦ diff åº”ä¸º 0
        const diff = buyShares > 0 ? currentCost - newAvg : 0; 
        
        // P&L calculation always uses the current market price and the new/existing average cost
        const pnlAmount = (marketPrice - newAvg) * totalShares;
        const pnlPercent = (marketPrice / newAvg - 1) * 100;

        // --- Aè‚¡é…è‰²é€»è¾‘ ---
        const pnlClass = pnlAmount >= 0 ? 'highlight-red' : 'highlight-green'; // ç›ˆåˆ©/ä¸Šæ¶¨ç”¨çº¢è‰²
        const diffClass = diff > 0 ? 'highlight-red' : (diff < 0 ? 'highlight-green' : ''); // æˆæœ¬ä¸‹é™ç”¨çº¢è‰²ï¼Œä¸Šå‡ç”¨ç»¿è‰² (è™½ç„¶é€šå¸¸ä¸ä¼šä¸Šå‡ï¼Œä½†ä»¥é˜²ä¸‡ä¸€)
        const pnlSign = pnlAmount >= 0 ? '+' : '';

        // åŠ¨æ€è°ƒæ•´ç»“æœå¡çš„æ˜¾ç¤ºå†…å®¹
        let costResultRow = '';
        let feeRow = '';
        
        if (buyShares > 0) {
             costResultRow = `
                <div class="result-row total">
                    <span>è¡¥ä»“åæˆæœ¬</span>
                    <span class="highlight-green">${newAvg.toFixed(3)} å…ƒ</span>
                </div>
                <div class="result-row">
                    <span>æˆæœ¬é™ä½å¹…åº¦</span>
                    <span class="${diffClass}">${diff.toFixed(3)} å…ƒ</span>
                </div>
            `;
            feeRow = `
                <div class="result-row">
                    <span>é¢„ä¼°æ‰‹ç»­è´¹</span>
                    <span>${fees.toFixed(2)} å…ƒ</span>
                </div>
            `;
        } else {
             costResultRow = `
                <div class="result-row total">
                    <span>ç°æœ‰æˆæœ¬</span>
                    <span class="highlight-green">${currentCost.toFixed(3)} å…ƒ</span>
                </div>
                <div class="result-row">
                    <span>æŒä»“è‚¡æ•°</span>
                    <span>${totalShares.toLocaleString()} è‚¡</span>
                </div>
            `;
            // å½“ buyShares = 0 æ—¶ï¼Œfees = 0ï¼Œä¸æ˜¾ç¤ºæ‰‹ç»­è´¹
        }

        const outputHTML = `
            <div class="result-row info">
                <span>${stockName}</span>
                <span>${new Date().toLocaleString()}</span>
            </div>
            ${buyShares > 0 ? `<div class="result-row"><span>æœ¬æ¬¡è¡¥ä»“é‡‘é¢</span><span>${buyAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })} å…ƒ</span></div>` : ''}
            ${feeRow}
            ${costResultRow}
            <hr style="border-top: 1px dashed #ccc; margin: 10px 0;">
            <div class="result-row">
                <span>å½“å‰ç›ˆäºé‡‘é¢ (${buyShares > 0 ? 'åŸºäºæ–°æˆæœ¬' : 'åŸºäºç°æœ‰æˆæœ¬'})</span>
                <span class="${pnlClass}">${pnlSign}${pnlAmount.toFixed(2).toLocaleString()} å…ƒ</span>
            </div>
            <div class="result-row">
                <span>å½“å‰ç›ˆäºæ¯”ä¾‹</span>
                <span class="${pnlClass}">${pnlSign}${pnlPercent.toFixed(2)} %</span>
            </div>
            <div class="fee-note">ç›ˆäºæ˜¯åŸºäºå½“å‰å¸‚ä»·å’Œå¹³å‡æˆæœ¬è®¡ç®—çš„ç†è®ºå€¼ã€‚</div>
        `;

        showResult(outputHTML);
        
        // Save to History and Clear Form
        saveHistory({
            mode: 'cost',
            stockName,
            memo,
            input: { currentShares, currentCost, marketPrice, buyShares },
            output: { newAvg, fees, buyAmount, totalShares, diff, pnlAmount, pnlPercent },
            html: outputHTML
        });
        clearForm();
    }

    function calculateTarget() {
        const stockName = document.getElementById('stockName').value.trim() || 'æœªå‘½åè‚¡ç¥¨/åŸºé‡‘';
        const memo = document.getElementById('memo').value.trim();
        const currentShares = parseFloat(document.getElementById('currentShares').value);
        const currentCost = parseFloat(document.getElementById('currentCost').value);
        const marketPrice = parseFloat(document.getElementById('marketPrice').value);
        const targetCost = parseFloat(document.getElementById('targetCost').value);

        if (isNaN(currentShares) || isNaN(currentCost) || isNaN(marketPrice) || isNaN(targetCost)) {
            showToast("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«çš„æ•°å­—é¡¹", 'error');
            return;
        }

        if (targetCost <= marketPrice) {
            showToast("ç›®æ ‡æˆæœ¬å¿…é¡»é«˜äºå½“å‰å¸‚åœºä»·ã€‚", 'error');
            return;
        }
        if (targetCost >= currentCost) {
            showToast("ç›®æ ‡æˆæœ¬åº”ä½äºå½“å‰æˆæœ¬ã€‚", 'error');
            return;
        }

        let found = false;
        let bestShares = 0;
        let bestFees = 0;
        
        const oldAmount = currentShares * currentCost;

        // æš´åŠ›æ±‚è§£æ³•ï¼ˆæ­¥é•¿100è‚¡ï¼‰
        for (let shares = 100; shares <= 1000000; shares += 100) {
            const buyAmount = shares * marketPrice;
            const fees = getFees(buyAmount);
            const newTotal = oldAmount + buyAmount + fees;
            const newAvg = newTotal / (currentShares + shares);

            if (newAvg <= targetCost) {
                found = true;
                bestShares = shares;
                bestFees = fees;
                break;
            }
        }

        let outputHTML;
        let pnlAmount = 0;
        let pnlPercent = 0;

        if (found) {
            const moneyNeeded = bestShares * marketPrice;
            const totalShares = currentShares + bestShares;
            
            pnlAmount = (marketPrice - targetCost) * totalShares;
            pnlPercent = (marketPrice / targetCost - 1) * 100;
            
            // --- Aè‚¡é…è‰²é€»è¾‘ ---
            const pnlClass = pnlAmount >= 0 ? 'highlight-red' : 'highlight-green'; // ç›ˆåˆ©/ä¸Šæ¶¨ç”¨çº¢è‰²
            const pnlSign = pnlAmount >= 0 ? '+' : '';

            outputHTML = `
                <div class="result-row info">
                    <span>${stockName}</span>
                    <span>${new Date().toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span>å»ºè®®è¡¥ä»“æ•°é‡</span>
                    <span class="highlight-green">${bestShares} è‚¡</span>
                </div>
                <div class="result-row">
                    <span>æ‰€éœ€èµ„é‡‘</span>
                    <span>${moneyNeeded.toLocaleString(undefined, { minimumFractionDigits: 2 })} å…ƒ</span>
                </div>
                 <div class="result-row">
                    <span>å«æ‰‹ç»­è´¹çº¦</span>
                    <span>${bestFees.toFixed(2)} å…ƒ</span>
                </div>
                <div class="result-row total">
                    <span>è¾¾æˆç›®æ ‡æˆæœ¬</span>
                    <span class="highlight-green">${targetCost.toFixed(3)} å…ƒ</span>
                </div>
                <hr style="border-top: 1px dashed #ccc; margin: 10px 0;">
                <div class="result-row">
                    <span>å½“å‰ç›ˆäºé‡‘é¢ (åŸºäºç›®æ ‡æˆæœ¬)</span>
                    <span class="${pnlClass}">${pnlSign}${pnlAmount.toFixed(2).toLocaleString()} å…ƒ</span>
                </div>
                <div class="result-row">
                    <span>å½“å‰ç›ˆäºæ¯”ä¾‹</span>
                    <span class="${pnlClass}">${pnlSign}${pnlPercent.toFixed(2)} %</span>
                </div>
                <div class="fee-note">ç›ˆäºæ˜¯åŸºäºå½“å‰å¸‚ä»·å’Œç›®æ ‡æˆæœ¬è®¡ç®—çš„ç†è®ºå€¼ã€‚</div>
            `;
            
            showResult(outputHTML);

            // Save to History and Clear Form
            saveHistory({
                mode: 'target',
                stockName,
                memo,
                input: { currentShares, currentCost, marketPrice, targetCost },
                output: { bestShares, moneyNeeded, bestFees, pnlAmount, pnlPercent },
                html: outputHTML
            });
            clearForm();
            
        } else {
            outputHTML = `<div style="text-align:center; color: var(--text-sub);">è®¡ç®—è¶…å‡ºèŒƒå›´ï¼ˆéœ€è¡¥ä»“è¶…è¿‡100ä¸‡è‚¡ï¼‰ï¼Œå»ºè®®é‡æ–°è®¾å®šç›®æ ‡æˆæœ¬ã€‚</div>`;
            showToast("éœ€è¦è¡¥ä»“çš„æ•°é‡è¿‡å¤§ï¼Œè¯·è°ƒæ•´ç›®æ ‡æˆæœ¬ã€‚", 'warning');
            showResult(outputHTML);
        }
    }

    // --- History Management ---

    function getHistory() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
    }

    function saveHistory(data) {
        const history = getHistory();
        const editingId = document.getElementById('editingId').value;
        let toastMessage = "";

        const newEntry = {
            id: editingId || Date.now(),
            timestamp: new Date().toLocaleString(),
            ...data
        };

        if (editingId) {
            const index = history.findIndex(item => item.id == editingId);
            if (index !== -1) {
                history[index] = newEntry;
            }
            toastMessage = "âœ… æŒä»“è®°å½•å·²æˆåŠŸä¿®æ”¹å¹¶é‡æ–°ä¿å­˜ï¼";
        } else {
            history.unshift(newEntry);
            if (history.length > 50) history.pop();
            toastMessage = "âœ… è®¡ç®—ç»“æœå·²ä¿å­˜åˆ°æŒä»“åˆ—è¡¨ï¼";
        }
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        showToast(toastMessage, 'success');
    }

    function deleteHistory(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æŒä»“è®°å½•å—ï¼Ÿ')) return;
        let history = getHistory();
        history = history.filter(item => item.id != id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        renderHistory();
        showToast("å·²åˆ é™¤ä¸€æ¡æŒä»“è®°å½•ã€‚", 'warning');
    }
    
    // åŠ è½½å†å²è®°å½•åˆ°è¾“å…¥æ¡† (ç”¨äºä¿®æ”¹/é‡æ–°è®¡ç®—)
    function editHistory(id) {
        const history = getHistory();
        const item = history.find(entry => entry.id == id);
        
        if (!item) return;

        // 1. æ¸…ç©ºå¹¶å¡«å……è¾“å…¥æ¡†
        clearForm();
        document.getElementById('stockName').value = item.stockName || '';
        document.getElementById('memo').value = item.memo || '';
        document.getElementById('currentShares').value = item.input.currentShares;
        document.getElementById('currentCost').value = item.input.currentCost;
        document.getElementById('marketPrice').value = item.input.marketPrice;
        
        // æ¨¡å¼ç›¸å…³çš„è¾“å…¥
        if (item.mode === 'cost') {
            document.getElementById('buyShares').value = item.input.buyShares;
        } else {
            document.getElementById('targetCost').value = item.input.targetCost;
        }
        
        // 2. åˆ‡æ¢å›ç›¸åº”çš„è®¡ç®—æ¨¡å¼å¹¶æ˜¾ç¤ºç»“æœ
        switchTab(item.mode);
        document.getElementById('resultCard').innerHTML = item.html;
        document.getElementById('resultCard').style.display = 'block';

        // 3. è®¾ç½®ç¼–è¾‘æ¨¡å¼æ ‡è®°
        document.getElementById('editingId').value = id;
        
        showToast(`ğŸ”” å·²åŠ è½½ ${item.stockName} çš„æŒä»“è®°å½•ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»è®¡ç®—æŒ‰é’®é‡æ–°ä¿å­˜ã€‚`, 'warning');
        document.getElementById('currentShares').scrollIntoView({ behavior: 'smooth' });
    }
    
    function renderHistory() {
        const history = getHistory();
        const list = document.getElementById('historyList');
        list.innerHTML = '';

        if (history.length === 0) {
            list.innerHTML = `<p style="text-align:center; color:var(--text-sub); margin-top: 50px;">æš‚æ— æŒä»“è®°å½•ã€‚</p>`;
            return;
        }

        history.forEach(item => {
            let detailLine1 = '';
            let detailLine2 = '';
            
            // --- Aè‚¡é…è‰²é€»è¾‘ ---
            const pnlClass = item.output.pnlAmount >= 0 ? 'highlight-red' : 'highlight-green';
            const pnlSign = item.output.pnlAmount >= 0 ? '+' : '';
            
            // æ ¼å¼åŒ–ç›ˆäºé‡‘é¢
            const pnlAmountFormatted = item.output.pnlAmount.toFixed(2).toLocaleString();
            const pnlPercentFormatted = item.output.pnlPercent.toFixed(2);
            
            if (item.mode === 'cost') {
                const buyShares = item.input.buyShares || 0;
                const buyInfo = buyShares > 0 ? `è¡¥ä»“ï¼š${buyShares} è‚¡ | æ–°æˆæœ¬ï¼š**${item.output.newAvg.toFixed(3)}** å…ƒ` : 'ä»…è®¡ç®—ç›ˆäº (é›¶è¡¥ä»“)';
                detailLine1 = `åŸæˆæœ¬ï¼š${item.input.currentCost.toFixed(3)} å…ƒ`;
                detailLine2 = buyInfo;
            } else {
                detailLine1 = `åŸæˆæœ¬ï¼š${item.input.currentCost.toFixed(3)} å…ƒ | ç›®æ ‡ï¼š${item.input.targetCost.toFixed(3)} å…ƒ`;
                detailLine2 = `éœ€è¡¥ä»“ï¼š**${item.output.bestShares ? item.output.bestShares.toLocaleString() + ' è‚¡' : 'è®¡ç®—å¤±è´¥'}**`;
            }
            
            const memoSnippet = item.memo ? `<span class="memo-snippet">ğŸ“ å¤‡æ³¨: ${item.memo}</span>` : '';

            const listItem = document.createElement('li');
            listItem.className = 'history-item';
            listItem.innerHTML = `
                <div class="history-item-header">
                    <span class="stock-name-display">${item.stockName || 'æœªå‘½å'}</span>
                    <span class="timestamp-display">${item.timestamp}</span>
                </div>
                <div class="history-item-content">
                    <span>${detailLine1}</span>
                    <span>${detailLine2}</span>
                    ${memoSnippet}
                </div>
                <div class="history-pnl">
                    <span class="pnl-label">å½“å‰ç›ˆäºé‡‘é¢:</span>
                    <span class="pnl-value ${pnlClass}">${pnlSign}${pnlAmountFormatted} å…ƒ</span>
                    
                    <span class="pnl-label">å½“å‰ç›ˆäºæ¯”ä¾‹:</span>
                    <span class="pnl-value ${pnlClass}">${pnlSign}${pnlPercentFormatted} %</span>
                </div>
                <div class="history-item-actions">
                    <button class="btn-edit" onclick="editHistory(${item.id})">ä¿®æ”¹/é‡ç®—</button>
                    <button class="btn-delete" onclick="deleteHistory(${item.id})">åˆ é™¤</button>
                </div>
            `;
            list.appendChild(listItem);
        });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œé»˜è®¤æ¸²æŸ“æŒä»“åˆ—è¡¨
    window.onload = function() {
        renderHistory();
        // ç¡®ä¿ calc area é»˜è®¤éšè—
        document.getElementById('calculator-area').style.display = 'none';
    };
</script>

</body>

</html>
